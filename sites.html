<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Nightscout Monitor Wall</title>
<meta name="theme-color" content="#121212">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  background:#121212;
  color:white;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:14px;
  padding:14px;
}

.tile{
  background:#1c1c1e;
  border-radius:16px;
  padding:14px;
  border:2px solid #2c2c2e;
  transition:.25s;
}

.name{
  font-size:13px;
  opacity:.7;
}

.value{
  font-size:44px;
  font-weight:600;
}

.delta{
  font-size:18px;
  opacity:.8;
}

.age{
  font-size:13px;
  opacity:.6;
}

canvas{
  margin-top:8px;
}

</style>
</head>

<body>
<div class="grid" id="grid"></div>

<script>

const sites = [
 {name:"Romania", url:"https://mstry9.nsromania.info/?token=read1-7bcf2859f8c8f39a"},
 {name:"Local Dell", url:"https://mstry9dell.duckdns.org:1338/?token=localread-a0cc5be899ab88f6"},
 {name:"Azure", url:"https://mstry9azure.azurewebsites.net/?token=read1-75f11cf6fb86a6ee"},
 {name:"Romania Online", url:"https://mstry9online.nsromania.info/?token=read1-cee46c0510d61c50"},
 {name:"Google", url:"https://mstry9google.nightscoutfree.com/?token=read1-85949d1e3fd02e59"},
 {name:"Google2", url:"https://mstry9google2.mooo.com/?token=alexa-3cdbb9b47a4f8afc"},
 {name:"Home", url:"https://mstry9home.duckdns.org:1338/?token=read1-5e12381731c72406"},
 {name:"Cloud Run", url:"https://mstry9--nightscout--cmnxw946qpz2.code.run/?token=read1-97a5f0f91c9e024c"}
];

function parse(siteURL){
  const u=new URL(siteURL);
  const token=u.searchParams.get("token");
  const base=u.origin;
  return {base,token};
}

function arrow(dir){
 return {
  Flat:"→",
  SingleUp:"↑",
  DoubleUp:"⇈",
  FortyFiveUp:"↗",
  FortyFiveDown:"↘",
  SingleDown:"↓",
  DoubleDown:"⇊"
 }[dir]||"•";
}

function color(v){
 if(v<70)return"#ff3b30";
 if(v<90)return"#ff9500";
 if(v<=160)return"#30d158";
 if(v<=220)return"#ffd60a";
 return"#bf5af2";
}

async function loadSite(site){

 const {base,token}=parse(site.url);

 const headers={
  "Authorization":"Bearer "+token
 };

 try{

 const entries=await fetch(base+"/api/v1/entries.json?count=72",{headers}).then(r=>r.json());

 if(!entries||entries.length===0)return;

 const latest=entries[0];
 const prev=entries[1];

 const sgv=latest.sgv;
 const delta=prev?sgv-prev.sgv:0;
 const age=Math.floor((Date.now()-latest.date)/60000);

 const tile=document.createElement("div");
 tile.className="tile";

 if(age>12) tile.style.borderColor="#ff3b30";
 else if(age>7) tile.style.borderColor="#ffd60a";

 tile.innerHTML=`
  <div class="name">${site.name}</div>
  <div class="value" style="color:${color(sgv)}">${sgv} ${arrow(latest.direction)}</div>
  <div class="delta">${delta>=0?`+${delta}`:delta}</div>
  <div class="age">${age} min ago</div>
  <canvas height="110"></canvas>
 `;

 document.getElementById("grid").appendChild(tile);

 const ctx=tile.querySelector("canvas").getContext("2d");

 const values=entries.slice().reverse().map(e=>e.sgv);
 const labels=entries.slice().reverse().map(e=>new Date(e.date).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));

 new Chart(ctx,{
  type:"line",
  data:{labels,datasets:[{
   data:values,
   borderColor:"#0a84ff",
   borderWidth:2,
   tension:.35,
   pointRadius:0
  }]},
  options:{
   responsive:true,
   plugins:{legend:{display:false}},
   scales:{x:{display:false},y:{display:false,min:50,max:300}}
  }
 });

 }catch(e){
  console.log("fail",site.name);
 }
}

async function refresh(){
 document.getElementById("grid").innerHTML="";
 for(const s of sites) await loadSite(s);
}

refresh();
setInterval(refresh,60000);

</script>
</body>
</html>